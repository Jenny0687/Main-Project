<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blue Horizon Defense</title>
</head>
<body>
  <h2>Blue Horizon Defense</h2>
  <p id="status">Upload a video to start</p>
  <video id="video" muted width="320" height="240"></video>
  <div class="caption">Video <input type="file" id="fileInput" name="file" /></div>
  <canvas id="canvasOutput" width="320" height="240"></canvas>
  <script async src="opencv.js" type="text/javascript" onload="onCvLoaded();"></script>
  

  <script>
    function onCvLoaded () {
        console.log('cv', cv);
        cv.onRuntimeInitialized = onReady;
    }
    let video = document.getElementById('video');
    let inputElement = document.getElementById('fileInput');
    inputElement.addEventListener('change', (e) => {
          video.src = URL.createObjectURL(e.target.files[0]);
        }, false);
        video.onload = function () {
          let mat = cv.imread(video);
          cv.imshow('canvasOutput', mat);
          mat.delete();
        };
    const actionBtn = document.getElementById('actionBtn');
    const FPS = 30;
    let stream;
    let streaming = false;
    function onReady () {
        console.log('ready?');
        let src;
        let dst;
        let cap;
    
        video.controls = true;
        video.addEventListener('play', start);
        video.addEventListener('pause', stop);
       // video.addEventListener('ended', stop);
    
        function start () {
            console.log('playing video');
            streaming = true;
            const width = video.width;
            const height = video.height;
            src = new cv.Mat(height, width, cv.CV_8UC4);
            dst = new cv.Mat(height, width, cv.CV_8UC1);
            cap = new cv.VideoCapture(video);
            setTimeout(processVideo, 0);
        }
    
        function stop () {
            console.log('paused or ended');
            streaming = false;
        }
    
        function processVideo () {
            if (!streaming) {
                src.delete();
                dst.delete();
                return;
            }
            const begin = Date.now();
            cap.read(src)
            cv.cvtColor(src, dst, cv.COLOR_RGBA2RGB);
            cv.imshow('canvasOutput', dst);
           // cv.imwrite('C:/Images', dst);
            const delay = 2000;//1000/FPS - (Date.now() - begin);
            
            setTimeout(processVideo, delay);
 
    
    
        }
    }

    
  </script>
  <script async src="https://docs.opencv.org/master/opencv.js" type="text/javascript"></script>
</body>
</html>